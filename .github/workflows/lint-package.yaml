# Scheduled lint check for the entire package
#
# Runs monthly to catch lint issues introduced by changes to lintr defaults
# or accumulated across multiple PRs. Opens an issue if problems are found.
on:
  schedule:
    # Run on the first day of each month at 9am UTC
    - cron: "0 9 1 * *"
  workflow_dispatch:

name: lint-package

jobs:
  lint-package:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6

      - uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            local::.
            any::lintr
            any::cyclocomp

      - name: Run lintr
        id: lintr
        run: |
          lints <- lintr::lint_package()
          if (length(lints) > 0) {
            writeLines("has_lints=true", Sys.getenv("GITHUB_OUTPUT"))
            writeLines(paste(capture.output(print(lints)), collapse = "\n"), "lint_results.txt")
          } else {
            writeLines("has_lints=false", Sys.getenv("GITHUB_OUTPUT"))
          }
        shell: Rscript {0}

      - name: Create or update issue
        if: steps.lintr.outputs.has_lints == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const lintResults = fs.readFileSync('lint_results.txt', 'utf8');
            const body = `The monthly lint check found issues:\n\n\`\`\`\n${lintResults}\n\`\`\`\n\n*Auto-generated by lint-package workflow*`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'lint'
            });

            const existing = issues.data.find(i => i.title === 'Scheduled lint check found issues');

            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Scheduled lint check found issues',
                body: body,
                labels: ['lint']
              });
            }
