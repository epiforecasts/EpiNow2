---
title: "Getting started with EpiNow2"
output:
  rmarkdown::html_vignette:
    toc: false
    number_sections: false
bibliography: library.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
vignette: >
  %\VignetteIndexEntry{Getting started with EpiNow2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


## Quick start

In the following section we give an overview of the simple use case for `epinow()` and `regional_epinow()`.

The first step to using the package is to load it as follows.


``` r
library(EpiNow2)
```

### Reporting delays, incubation period and generation time

Distributions can be supplied in two ways. First, one can supply delay data to `estimate_delay()`, where a subsampled bootstrapped lognormal will be fit to account for uncertainty in the observed data without being biased by changes in incidence (see `?EpiNow2::estimate_delay()`).

Second, one can specify predetermined delays with uncertainty using the distribution functions such as `Gamma` or `Lognormal`. An arbitrary number of delay distributions are supported in `dist_spec()` with a common use case being an incubation period followed by a reporting delay. For more information on specifying distributions see (see `?EpiNow2::Distributions`).

For example if data on the delay between onset and infection was available we could fit a distribution to it, using `estimate_delay()`, with appropriate uncertainty as follows (note this is a synthetic example),

``` r
reporting_delay <- estimate_delay(
  rlnorm(1000, log(2), 1),
  max_value = 14, bootstraps = 1
)
```

If data was not available we could instead specify an informed estimate of the likely delay using the distribution functions `Gamma` or `LogNormal`. 
To demonstrate, we choose a lognormal distribution with mean 2, standard deviation 1 and a maximum of 10. *This is just an example and unlikely to apply in any particular use case*.


``` r
reporting_delay <- LogNormal(mean = 2, sd = 1, max = 10)
reporting_delay
#> - lognormal distribution (max: 10):
#>   meanlog:
#>     0.58
#>   sdlog:
#>     0.47
```

For the rest of this vignette, we will use inbuilt example literature estimates for the incubation period and generation time of Covid-19 (see [here](https://github.com/epiforecasts/EpiNow2/tree/main/data-raw) for the code that generates these estimates). *These distributions are unlikely to be applicable for your use case. We strongly recommend investigating what might be the best distributions to use in any given use case.*


``` r
example_generation_time
#> - gamma distribution (max: 14):
#>   shape:
#>     - normal distribution:
#>       mean:
#>         1.4
#>       sd:
#>         0.48
#>   rate:
#>     - normal distribution:
#>       mean:
#>         0.38
#>       sd:
#>         0.25
example_incubation_period
#> - lognormal distribution (max: 14):
#>   meanlog:
#>     - normal distribution:
#>       mean:
#>         1.6
#>       sd:
#>         0.064
#>   sdlog:
#>     - normal distribution:
#>       mean:
#>         0.42
#>       sd:
#>         0.069
```

Users can also pass a non-parametric delay distribution vector using the `NonParametric` option 
for both the generation interval and reporting delays. It is important to note that if doing so,
both delay distributions are 0-indexed, meaning the first element corresponds to the probability mass
at day 0 of an individual's infection. Because the discretised renewal equation doesn't support mass on day 0, the generation interval should be passed in as a 0-indexed vector with a mass of zero on day 0. 


``` r
example_non_parametric_gi <-  NonParametric(pmf = c(0, 0.3, 0.5, 0.2))

example_non_parametric_delay <- NonParametric(pmf = c(0.01, 0.1, 0.5, 0.3, 0.09))
```
These distributions are passed to downstream functions in the same way that the 
parametric distributions are. 

Now, to the functions.

### [epinow()](https://epiforecasts.io/EpiNow2/reference/epinow.html)

This function represents the core functionality of the package and includes results reporting, plotting, and optional saving. It requires a data frame of cases by date of report and the distributions defined above.

Load example case data from `{EpiNow2}`.


``` r
reported_cases <- example_confirmed[1:60]
head(reported_cases)
#>          date confirm
#>        <Date>   <num>
#> 1: 2020-02-22      14
#> 2: 2020-02-23      62
#> 3: 2020-02-24      53
#> 4: 2020-02-25      97
#> 5: 2020-02-26      93
#> 6: 2020-02-27      78
```

Estimate cases by date of infection, the time-varying reproduction number, the rate of growth, and forecast these estimates into the future by 7 days. Summarise the posterior and return a summary table and plots for reporting purposes. If a `target_folder` is supplied results can be internally saved (with the option to also turn off explicit returning of results). Here we use the default model parameterisation that prioritises real-time performance over run-time or other considerations. For other formulations see the documentation for `estimate_infections()`.


``` r
estimates <- epinow(
  data = reported_cases,
  generation_time = gt_opts(example_generation_time),
  delays = delay_opts(example_incubation_period + reporting_delay),
  rt = rt_opts(prior = LogNormal(mean = 2, sd = 0.2)),
  stan = stan_opts(cores = 4),
  verbose = interactive()
)
names(estimates)
#> [1] "estimates"                "estimated_reported_cases"
#> [3] "summary"                  "plots"                   
#> [5] "timing"
```

Both summary measures and posterior samples are returned for all parameters in an easily explored format which can be accessed using `summary`. The default is to return a summary table of estimates for key parameters at the latest date partially supported by data. 


``` r
knitr::kable(summary(estimates))
```



|measure                      |estimate                |numeric_estimate                                                              |
|:----------------------------|:-----------------------|:-----------------------------------------------------------------------------|
|New infections per day       |1806 (811 -- 4374)      |1806, 2109, 1502, 811, 1280, 1584, 2050, 2596, 4374                           |
|Expected change in reports   |Likely decreasing       |0.81                                                                          |
|Effective reproduction no.   |0.89 (0.73 -- 1.1)      |0.89, 0.90, 0.12, 0.73, 0.82, 0.86, 0.92, 0.97, 1.10                          |
|Rate of growth               |-0.031 (-0.08 -- 0.026) |-0.0310, -0.0290, 0.0330, -0.0800, -0.0520, -0.0390, -0.0220, -0.0079, 0.0260 |
|Doubling/halving time (days) |-22 (26 -- -8.7)        |-22.0, -24.0, 21.0, -8.7, -13.0, -18.0, -31.0, -88.0, 26.0                    |



Summarised parameter estimates can also easily be returned, either filtered for a single parameter or for all parameters.


``` r
head(summary(estimates, type = "parameters", params = "R"))
#>                         measure                estimate  numeric_estimate
#>                          <char>                  <char>            <list>
#> 1:       New infections per day      1806 (811 -- 4374) <data.table[1x9]>
#> 2:   Expected change in reports       Likely decreasing              0.81
#> 3:   Effective reproduction no.      0.89 (0.73 -- 1.1) <data.table[1x9]>
#> 4:               Rate of growth -0.031 (-0.08 -- 0.026) <data.table[1x9]>
#> 5: Doubling/halving time (days)        -22 (26 -- -8.7) <data.table[1x9]>
```

Reported cases are returned in a separate data frame in order to streamline the reporting of forecasts and for model evaluation.


``` r
head(summary(estimates, output = "estimated_reported_cases"))
#> $samples
#>               date sample cases   type
#>             <Date>  <int> <num> <char>
#>      1: 2020-02-22      1    37  gp_rt
#>      2: 2020-02-23      1    37  gp_rt
#>      3: 2020-02-24      1    80  gp_rt
#>      4: 2020-02-25      1    54  gp_rt
#>      5: 2020-02-26      1    82  gp_rt
#>     ---                               
#> 133996: 2020-04-24   2000  3223  gp_rt
#> 133997: 2020-04-25   2000  2673  gp_rt
#> 133998: 2020-04-26   2000  2874  gp_rt
#> 133999: 2020-04-27   2000  2375  gp_rt
#> 134000: 2020-04-28   2000  1564  gp_rt
#> 
#> $summarised
#>           date   type median      mean          sd lower_90 lower_50 lower_20
#>         <Date> <char>  <num>     <num>       <num>    <num>    <num>    <num>
#>  1: 2020-02-22  gp_rt   35.0   35.8775    9.657232    21.00    29.00     33.0
#>  2: 2020-02-23  gp_rt   52.0   53.4180   12.856746    34.00    44.00     49.0
#>  3: 2020-02-24  gp_rt   64.0   65.2095   15.316883    42.00    54.00     60.0
#>  4: 2020-02-25  gp_rt   72.5   73.3315   16.496475    49.00    61.00     68.0
#>  5: 2020-02-26  gp_rt   82.0   83.5730   18.547093    55.00    71.00     78.0
#>  6: 2020-02-27  gp_rt  118.0  120.6435   25.653956    83.00   103.00    113.0
#>  7: 2020-02-28  gp_rt  188.0  190.6215   38.167088   134.00   164.00    178.0
#>  8: 2020-02-29  gp_rt  213.0  216.1940   42.692783   149.95   187.00    202.0
#>  9: 2020-03-01  gp_rt  310.0  314.6790   62.000605   223.00   272.00    295.6
#> 10: 2020-03-02  gp_rt  367.0  374.9045   74.218870   266.00   323.75    350.0
#> 11: 2020-03-03  gp_rt  397.5  403.1025   78.030939   287.00   348.00    379.0
#> 12: 2020-03-04  gp_rt  432.0  437.1450   86.504881   307.00   377.00    411.0
#> 13: 2020-03-05  gp_rt  594.5  602.2810  115.493053   428.95   521.75    566.0
#> 14: 2020-03-06  gp_rt  894.0  901.9405  166.977093   644.95   787.00    847.0
#> 15: 2020-03-07  gp_rt  955.0  966.3365  184.408507   697.00   838.00    903.6
#> 16: 2020-03-08  gp_rt 1303.0 1313.6555  247.226170   936.80  1149.75   1245.0
#> 17: 2020-03-09  gp_rt 1476.0 1490.7220  282.345668  1062.95  1291.00   1410.6
#> 18: 2020-03-10  gp_rt 1467.0 1485.2575  279.848625  1066.00  1293.75   1401.0
#> 19: 2020-03-11  gp_rt 1520.0 1534.5080  291.557093  1094.95  1333.75   1445.0
#> 20: 2020-03-12  gp_rt 1944.5 1964.3855  375.244658  1389.00  1707.50   1848.2
#> 21: 2020-03-13  gp_rt 2718.0 2748.3405  531.041466  1920.95  2382.00   2584.6
#> 22: 2020-03-14  gp_rt 2754.0 2780.5820  518.132515  1995.00  2404.00   2629.6
#> 23: 2020-03-15  gp_rt 3504.0 3560.6045  667.896001  2556.90  3108.50   3348.2
#> 24: 2020-03-16  gp_rt 3635.5 3687.1235  684.431917  2669.00  3204.00   3454.0
#> 25: 2020-03-17  gp_rt 3454.0 3495.3145  643.791467  2521.95  3047.00   3291.0
#> 26: 2020-03-18  gp_rt 3287.0 3328.0385  596.328278  2419.95  2913.50   3144.6
#> 27: 2020-03-19  gp_rt 3906.0 3960.3710  749.530907  2821.85  3437.00   3735.2
#> 28: 2020-03-20  gp_rt 5164.5 5222.6385  971.466511  3724.70  4548.75   4939.6
#> 29: 2020-03-21  gp_rt 4860.0 4889.3980  896.622736  3471.85  4256.75   4624.6
#> 30: 2020-03-22  gp_rt 5732.5 5780.9040 1095.276708  4116.85  5045.50   5459.6
#> 31: 2020-03-23  gp_rt 5575.0 5641.3150 1031.694589  4074.70  4942.00   5328.0
#> 32: 2020-03-24  gp_rt 4965.5 5033.5970  931.381268  3642.00  4370.75   4746.0
#> 33: 2020-03-25  gp_rt 4386.0 4448.3610  859.869173  3130.75  3864.75   4183.0
#> 34: 2020-03-26  gp_rt 5011.0 5064.2000  942.164693  3575.85  4405.25   4781.0
#> 35: 2020-03-27  gp_rt 6072.0 6171.8790 1135.723200  4529.15  5396.00   5811.4
#> 36: 2020-03-28  gp_rt 5433.5 5492.7450  990.259028  3954.50  4816.50   5211.0
#> 37: 2020-03-29  gp_rt 6106.0 6187.0195 1136.911702  4447.85  5385.75   5842.2
#> 38: 2020-03-30  gp_rt 5709.0 5798.7750 1080.067591  4152.15  5066.50   5460.6
#> 39: 2020-03-31  gp_rt 4776.0 4863.9835  907.093485  3544.85  4254.00   4578.6
#> 40: 2020-04-01  gp_rt 4144.0 4205.1825  810.879486  2973.90  3665.50   3970.2
#> 41: 2020-04-02  gp_rt 4518.5 4581.9520  878.361160  3273.00  3972.00   4315.0
#> 42: 2020-04-03  gp_rt 5402.5 5452.1305 1009.666710  3926.95  4735.25   5147.6
#> 43: 2020-04-04  gp_rt 4656.5 4724.0310  879.382139  3380.90  4121.75   4460.6
#> 44: 2020-04-05  gp_rt 5138.0 5219.8930  970.989940  3756.80  4551.00   4912.0
#> 45: 2020-04-06  gp_rt 4753.0 4807.8155  891.924791  3490.60  4170.00   4540.6
#> 46: 2020-04-07  gp_rt 3988.0 4026.3480  775.775144  2838.00  3493.50   3794.0
#> 47: 2020-04-08  gp_rt 3342.0 3389.5540  629.271294  2440.85  2951.75   3195.0
#> 48: 2020-04-09  gp_rt 3658.0 3694.4830  686.836525  2627.65  3223.00   3486.6
#> 49: 2020-04-10  gp_rt 4389.0 4422.8765  813.529812  3192.95  3826.75   4189.6
#> 50: 2020-04-11  gp_rt 3763.0 3807.7645  700.623921  2738.90  3331.75   3585.8
#> 51: 2020-04-12  gp_rt 4132.0 4184.5845  756.604282  3033.85  3675.75   3961.0
#> 52: 2020-04-13  gp_rt 3784.0 3848.1585  719.658257  2764.90  3350.25   3619.0
#> 53: 2020-04-14  gp_rt 3151.0 3199.5835  590.422943  2279.90  2789.75   3017.2
#> 54: 2020-04-15  gp_rt 2702.5 2745.9890  527.461682  1979.80  2380.75   2581.0
#> 55: 2020-04-16  gp_rt 2970.0 3003.8115  564.857319  2162.90  2608.00   2815.0
#> 56: 2020-04-17  gp_rt 3525.0 3570.7560  673.434535  2537.95  3122.00   3378.0
#> 57: 2020-04-18  gp_rt 3014.5 3075.1035  577.842165  2216.80  2674.75   2880.0
#> 58: 2020-04-19  gp_rt 3368.0 3408.8515  648.741003  2425.70  2952.75   3211.6
#> 59: 2020-04-20  gp_rt 3098.5 3139.9525  619.197884  2218.70  2704.00   2939.0
#> 60: 2020-04-21  gp_rt 2593.5 2629.1950  536.693833  1820.95  2260.00   2467.6
#> 61: 2020-04-22  gp_rt 2199.5 2242.7790  473.207104  1533.90  1910.00   2086.0
#> 62: 2020-04-23  gp_rt 2378.0 2437.1255  572.263701  1614.95  2024.00   2256.2
#> 63: 2020-04-24  gp_rt 2840.0 2913.4010  711.917148  1874.95  2420.50   2671.2
#> 64: 2020-04-25  gp_rt 2461.5 2542.5920  662.410283  1612.90  2077.50   2307.6
#> 65: 2020-04-26  gp_rt 2711.0 2836.3875  840.503162  1716.90  2262.75   2535.0
#> 66: 2020-04-27  gp_rt 2467.5 2606.3760  833.354824  1567.95  2029.50   2287.6
#> 67: 2020-04-28  gp_rt 2088.5 2216.3130  766.765361  1229.00  1697.00   1927.6
#>           date   type median      mean          sd lower_90 lower_50 lower_20
#>     upper_20 upper_50 upper_90
#>        <num>    <num>    <num>
#>  1:     38.0    42.00    52.00
#>  2:     56.0    61.00    76.00
#>  3:     68.0    75.00    92.00
#>  4:     76.0    84.00   102.00
#>  5:     87.0    95.00   117.00
#>  6:    125.0   135.00   167.00
#>  7:    197.0   214.00   257.05
#>  8:    224.4   242.00   292.00
#>  9:    325.0   353.00   425.00
#> 10:    388.0   422.00   504.00
#> 11:    416.0   453.00   538.05
#> 12:    452.0   488.00   583.05
#> 13:    624.0   673.00   805.00
#> 14:    935.0  1010.00  1194.10
#> 15:   1000.4  1082.25  1286.00
#> 16:   1354.0  1456.00  1754.05
#> 17:   1547.0  1665.00  1976.05
#> 18:   1535.0  1657.00  1956.05
#> 19:   1591.4  1721.00  2025.05
#> 20:   2038.0  2186.25  2619.05
#> 21:   2864.0  3088.00  3652.20
#> 22:   2892.8  3109.00  3662.30
#> 23:   3677.8  3978.25  4771.10
#> 24:   3824.8  4131.00  4908.20
#> 25:   3613.0  3883.00  4648.15
#> 26:   3446.4  3693.25  4345.10
#> 27:   4096.4  4430.50  5252.20
#> 28:   5413.6  5805.25  6901.00
#> 29:   5085.0  5472.50  6481.25
#> 30:   5982.0  6433.25  7618.35
#> 31:   5838.8  6281.25  7442.90
#> 32:   5193.4  5621.25  6656.25
#> 33:   4587.0  4970.25  5996.05
#> 34:   5263.4  5686.50  6648.15
#> 35:   6341.4  6848.25  8180.45
#> 36:   5688.4  6113.00  7238.15
#> 37:   6398.0  6879.75  8159.05
#> 38:   5997.0  6471.00  7706.00
#> 39:   4985.0  5396.25  6571.65
#> 40:   4351.4  4681.50  5620.00
#> 41:   4718.8  5119.50  6103.10
#> 42:   5638.4  6102.00  7206.05
#> 43:   4891.4  5296.25  6208.80
#> 44:   5387.8  5786.00  6984.10
#> 45:   4965.0  5346.25  6355.05
#> 46:   4170.4  4492.00  5374.60
#> 47:   3507.0  3786.25  4461.20
#> 48:   3826.0  4109.00  4858.15
#> 49:   4587.4  4938.00  5827.25
#> 50:   3937.4  4248.25  5021.05
#> 51:   4333.4  4655.50  5482.05
#> 52:   3968.4  4294.25  5087.20
#> 53:   3310.0  3565.25  4202.10
#> 54:   2840.0  3047.00  3654.05
#> 55:   3116.0  3341.25  4016.05
#> 56:   3678.8  3958.50  4738.35
#> 57:   3174.0  3423.00  4124.05
#> 58:   3525.0  3824.50  4506.10
#> 59:   3241.8  3543.25  4224.40
#> 60:   2725.0  2962.50  3567.05
#> 61:   2320.4  2529.00  3104.10
#> 62:   2521.4  2784.25  3447.15
#> 63:   2996.0  3312.25  4248.00
#> 64:   2615.0  2933.25  3749.55
#> 65:   2892.8  3271.25  4405.05
#> 66:   2649.0  3031.25  4136.15
#> 67:   2275.0  2592.50  3607.00
#>     upper_20 upper_50 upper_90
```

A range of plots are returned (with the single summary plot shown below). These plots can also be generated using the following `plot` method.


``` r
plot(estimates)
```

![plot of chunk plot_estimates](EpiNow2-plot_estimates-1.png)


### [regional_epinow()](https://epiforecasts.io/EpiNow2/reference/regional_epinow.html)

The `regional_epinow()` function runs the `epinow()` function across multiple regions in
an efficient manner.

Define cases in multiple regions delineated by the region variable.


``` r
reported_cases <- data.table::rbindlist(list(
  data.table::copy(reported_cases)[, region := "testland"],
  reported_cases[, region := "realland"]
))
head(reported_cases)
#>          date confirm   region
#>        <Date>   <num>   <char>
#> 1: 2020-02-22      14 testland
#> 2: 2020-02-23      62 testland
#> 3: 2020-02-24      53 testland
#> 4: 2020-02-25      97 testland
#> 5: 2020-02-26      93 testland
#> 6: 2020-02-27      78 testland
```

Calling `regional_epinow()` runs the `epinow()` on each region in turn (or in parallel depending on the settings used). Here we switch to using a weekly random walk rather than the full Gaussian process model giving us piecewise constant estimates by week. We also assign "testland" a different ascertainment of 50%, using the `opts_list()` function, which is used to assign region-specific settings.


``` r
obs <- opts_list(
  obs_opts(),
  reported_cases,
  testland = obs_opts(scale = Fixed(0.5))
)

estimates <- regional_epinow(
  data = reported_cases,
  generation_time = gt_opts(example_generation_time),
  delays = delay_opts(example_incubation_period + reporting_delay),
  rt = rt_opts(prior = LogNormal(mean = 2, sd = 0.2), rw = 7),
  obs = obs,
  gp = NULL,
  stan = stan_opts(cores = 4, warmup = 250, samples = 1000)
)
#> INFO [2025-12-01 00:26:32] Producing following optional outputs: regions, summary, samples, plots, latest
#> INFO [2025-12-01 00:26:32] Reporting estimates using data up to: 2020-04-21
#> INFO [2025-12-01 00:26:32] No target directory specified so returning output
#> INFO [2025-12-01 00:26:32] Producing estimates for: testland, realland
#> INFO [2025-12-01 00:26:32] Regions excluded: none
#> INFO [2025-12-01 00:26:53] Completed estimates for: testland
#> INFO [2025-12-01 00:27:14] Completed estimates for: realland
#> INFO [2025-12-01 00:27:14] Completed regional estimates
#> INFO [2025-12-01 00:27:14] Regions with estimates: 2
#> INFO [2025-12-01 00:27:14] Regions with runtime errors: 0
#> INFO [2025-12-01 00:27:14] Producing summary
#> INFO [2025-12-01 00:27:14] No summary directory specified so returning summary output
#> INFO [2025-12-01 00:27:15] No target directory specified so returning timings
```

Results from each region are stored in a `regional` list with across region summary measures and plots stored in a `summary` list. All results can be set to be internally saved by setting the `target_folder` and `summary_dir` arguments. Each region can be estimated in parallel using the `{future}` package (when in most scenarios `cores` should be set to 1). For routine use each MCMC chain can also be run in parallel (with `future` = `TRUE`) with a time out (`max_execution_time`) allowing for partial results to be returned if a subset of chains is running longer than expected. See the documentation for the [`{future}`](https://future.futureverse.org/) package for details on nested futures.

Summary measures that are returned include a table formatted for reporting (along with raw results for further processing).


``` r
knitr::kable(estimates$summary$summarised_results$table)
```



|Region   |New infections per day |Expected change in reports |Effective reproduction no. |Rate of growth          |Doubling/halving time (days) |
|:--------|:----------------------|:--------------------------|:--------------------------|:-----------------------|:----------------------------|
|realland |1471 (439 -- 5640)     |Likely decreasing          |0.85 (0.6 -- 1.2)          |-0.042 (-0.12 -- 0.045) |-16 (16 -- -5.8)             |
|testland |3088 (844 -- 11478)    |Likely decreasing          |0.86 (0.6 -- 1.2)          |-0.04 (-0.12 -- 0.046)  |-17 (15 -- -5.7)             |



A range of plots are again returned (with the single summary plot shown below).


``` r
estimates$summary$summary_plot
```

![plot of chunk plot_regional_epinow_summary](EpiNow2-plot_regional_epinow_summary-1.png)
