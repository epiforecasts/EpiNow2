# Estimate Infections, the Time-Varying Reproduction Number and the Rate of Growth

**\[maturing\]** Uses a non-parametric approach to reconstruct cases by
date of infection from reported cases. It uses either a generative Rt
model or non-parametric back calculation to estimate underlying latent
infections and then maps these infections to observed cases via
uncertain reporting delays and a flexible observation model. See the
examples and function arguments for the details of all options. The
default settings may not be sufficient for your use case so the number
of warmup samples (`stan_args = list(warmup)`) may need to be increased
as may the overall number of samples. Follow the links provided by any
warnings messages to diagnose issues with the MCMC fit. It is
recommended to explore several of the Rt estimation approaches supported
as not all of them may be suited to users own use cases. See
[here](https://gist.github.com/seabbs/163d0f195892cde685c70473e1f5e867)
for an example of using `estimate_infections` within the `epinow`
wrapper to estimate Rt for Covid-19 in a country from the ECDC data
source.

## Usage

``` r
estimate_infections(
  data,
  generation_time = gt_opts(),
  delays = delay_opts(),
  truncation = trunc_opts(),
  rt = rt_opts(),
  backcalc = backcalc_opts(),
  gp = gp_opts(),
  obs = obs_opts(),
  forecast = forecast_opts(),
  stan = stan_opts(),
  id = "estimate_infections",
  verbose = interactive()
)
```

## Arguments

- data:

  A `<data.frame>` of disease reports (confirm) by date (date).
  `confirm` must be numeric and `date` must be in date format.
  Optionally, `data` can also have a logical `accumulate` column which
  indicates whether data should be added to the next data point. This is
  useful when modelling e.g. weekly incidence data. See also the
  [`fill_missing()`](https://epiforecasts.io/EpiNow2/dev/reference/fill_missing.md)
  function which helps add the `accumulate` column with the desired
  properties when dealing with non-daily data. If any accumulation is
  done this happens after truncation as specified by the `truncation`
  argument. If all entries of `confirm` are missing (`NA`) the returned
  estimates will represent the prior distributions.

- generation_time:

  A call to
  [`gt_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/generation_time_opts.md)
  (or its alias
  [`generation_time_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/generation_time_opts.md))
  defining the generation time distribution used. For backwards
  compatibility a list of summary parameters can also be passed.

- delays:

  A call to
  [`delay_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/delay_opts.md)
  defining delay distributions and options. See the documentation of
  [`delay_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/delay_opts.md)
  and the examples below for details.

- truncation:

  A call to
  [`trunc_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/trunc_opts.md)
  defining the truncation of the observed data. Defaults to
  [`trunc_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/trunc_opts.md),
  i.e. no truncation. See the
  [`estimate_truncation()`](https://epiforecasts.io/EpiNow2/dev/reference/estimate_truncation.md)
  help file for an approach to estimating this from data where the
  `dist` list element returned by
  [`estimate_truncation()`](https://epiforecasts.io/EpiNow2/dev/reference/estimate_truncation.md)
  is used as the `truncation` argument here, thereby propagating the
  uncertainty in the estimate.

- rt:

  A list of options as generated by
  [`rt_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/rt_opts.md)
  defining Rt estimation. Defaults to
  [`rt_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/rt_opts.md).
  To generate new infections using the non-mechanistic model instead of
  the renewal equation model, use `rt = NULL`. The non-mechanistic model
  internally uses the setting
  `rt = rt_opts(use_rt = FALSE, future = "project", gp_on = "R0")`.

- backcalc:

  A list of options as generated by
  [`backcalc_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/backcalc_opts.md)
  to define the back calculation. Defaults to
  [`backcalc_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/backcalc_opts.md).

- gp:

  A list of options as generated by
  [`gp_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/gp_opts.md)
  to define the Gaussian process. Defaults to
  [`gp_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/gp_opts.md).
  Set to `NULL` to disable the Gaussian process.

- obs:

  A list of options as generated by
  [`obs_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/obs_opts.md)
  defining the observation model. Defaults to
  [`obs_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/obs_opts.md).

- forecast:

  A list of options as generated by
  [`forecast_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/forecast_opts.md)
  defining the forecast opitions. Defaults to
  [`forecast_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/forecast_opts.md).
  If NULL then no forecasting will be done.

- stan:

  A list of stan options as generated by
  [`stan_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/stan_opts.md).
  Defaults to
  [`stan_opts()`](https://epiforecasts.io/EpiNow2/dev/reference/stan_opts.md).
  Can be used to override `data`, `init`, and `verbose` settings if
  desired.

- id:

  A character string used to assign logging information on error. Used
  by
  [`regional_epinow()`](https://epiforecasts.io/EpiNow2/dev/reference/regional_epinow.md)
  to assign errors to regions. Alter the default to run with error
  catching.

- verbose:

  Logical, defaults to `TRUE` when used interactively and otherwise
  `FALSE`. Should verbose debug progress messages be printed.
  Corresponds to the "DEBUG" level from `futile.logger`. See
  `setup_logging` for more detailed logging options.

## Value

An `<estimate_infections>` object containing:

- `fit`: The stan fit object.

- `args`: A list of arguments used for fitting (stan data).

- `observations`: The input data (`<data.frame>`).

## See also

[`get_samples()`](https://epiforecasts.io/EpiNow2/dev/reference/get_samples.md)
[`get_predictions()`](https://epiforecasts.io/EpiNow2/dev/reference/get_predictions.md)
[`get_parameters()`](https://epiforecasts.io/EpiNow2/dev/reference/get_parameters.md)
[`epinow()`](https://epiforecasts.io/EpiNow2/dev/reference/epinow.md)
[`regional_epinow()`](https://epiforecasts.io/EpiNow2/dev/reference/regional_epinow.md)
[`forecast_infections()`](https://epiforecasts.io/EpiNow2/dev/reference/forecast_infections.md)
[`estimate_truncation()`](https://epiforecasts.io/EpiNow2/dev/reference/estimate_truncation.md)

## Examples

``` r
# \donttest{
# set number of cores to use
old_opts <- options()
options(mc.cores = ifelse(interactive(), 4, 1))

# get example case counts
reported_cases <- example_confirmed[1:40]

# set an example generation time. In practice this should use an estimate
# from the literature or be estimated from data
generation_time <- Gamma(
  shape = Normal(1.3, 0.3),
  rate = Normal(0.37, 0.09),
  max = 14
)
# set an example incubation period. In practice this should use an estimate
# from the literature or be estimated from data
incubation_period <- LogNormal(
  meanlog = Normal(1.6, 0.06),
  sdlog = Normal(0.4, 0.07),
  max = 14
)
# set an example reporting delay. In practice this should use an estimate
# from the literature or be estimated from data
reporting_delay <- LogNormal(mean = 2, sd = 1, max = 10)

# for more examples, see the "estimate_infections examples" vignette
# samples and calculation time have been reduced for this example
# for real analyses, use at least samples = 2000
def <- estimate_infections(reported_cases,
  generation_time = gt_opts(generation_time),
  delays = delay_opts(incubation_period + reporting_delay),
  rt = rt_opts(prior = LogNormal(mean = 2, sd = 0.1)),
  stan = stan_opts(samples = 100, warmup = 200)
)
#> Warning: The largest R-hat is NA, indicating chains have not mixed.
#> Running the chains for more iterations may help. See
#> https://mc-stan.org/misc/warnings.html#r-hat
#> Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
#> Running the chains for more iterations may help. See
#> https://mc-stan.org/misc/warnings.html#bulk-ess
#> Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
#> Running the chains for more iterations may help. See
#> https://mc-stan.org/misc/warnings.html#tail-ess
# real time estimates
summary(def)
#>                         measure                 estimate
#>                          <char>                   <char>
#> 1:       New infections per day      3482 (2122 -- 5449)
#> 2:   Expected change in reports               Decreasing
#> 3:   Effective reproduction no.      0.81 (0.67 -- 0.99)
#> 4:               Rate of growth -0.066 (-0.12 -- -0.001)
#> 5: Doubling/halving time (days)       -11 (-700 -- -5.6)
# summary plot
plot(def)

options(old_opts)
# }
```
